// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================================
// TENANT - Multi-tenant organization/team
// ============================================================================
model Tenant {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique // for URL (e.g., "acme-corp")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  memberships UserTenant[]
  boards      Board[]
  todos       Todo[]
  activities  TodoActivity[]

  @@map("tenants")
}

// ============================================================================
// USER - Global user, can belong to multiple tenants
// ============================================================================
model User {
  id           String   @id @default(uuid())
  email        String   @unique
  passwordHash String
  displayName  String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  memberships    UserTenant[]
  boardsCreated  Board[]        @relation("BoardCreatedBy")
  todosCreated   Todo[]         @relation("TodoCreatedBy")
  todosAssigned  Todo[]         @relation("TodoAssignee")
  activities     TodoActivity[]

  @@map("users")
}

// ============================================================================
// USER_TENANT - Join table userâ†’tenant with role
// ============================================================================
model UserTenant {
  id        String   @id @default(uuid())
  userId    String
  tenantId  String
  role      String   @default("member") // 'owner' | 'admin' | 'member'
  createdAt DateTime @default(now())

  // Relations
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([userId, tenantId])
  @@index([tenantId])
  @@index([userId])
  @@map("user_tenants")
}

// ============================================================================
// BOARD - Kanban board belonging to a tenant
// ============================================================================
model Board {
  id          String   @id @default(uuid())
  tenantId    String
  name        String
  description String?
  createdById String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  createdBy  User           @relation("BoardCreatedBy", fields: [createdById], references: [id])
  todos      Todo[]
  activities TodoActivity[]

  @@unique([tenantId, name]) // prevent duplicate names per tenant
  @@index([tenantId])
  @@map("boards")
}

// ============================================================================
// TODO - Individual task with status
// ============================================================================
enum TodoStatus {
  TODO
  IN_PROGRESS
  DONE
}

model Todo {
  id          String     @id @default(uuid())
  tenantId    String
  boardId     String
  title       String
  description String?
  status      TodoStatus @default(TODO)
  assigneeId  String? // optional
  createdById String
  position    Int        @default(0) // for ordering within the board
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relations
  tenant     Tenant         @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  board      Board          @relation(fields: [boardId], references: [id], onDelete: Cascade)
  assignee   User?          @relation("TodoAssignee", fields: [assigneeId], references: [id], onDelete: SetNull)
  createdBy  User           @relation("TodoCreatedBy", fields: [createdById], references: [id])
  activities TodoActivity[]

  @@index([tenantId])
  @@index([boardId])
  @@index([status])
  @@index([assigneeId])
  @@map("todos")
}

// ============================================================================
// TODO_ACTIVITY - Audit log for todo actions
// ============================================================================
model TodoActivity {
  id        String   @id @default(uuid())
  tenantId  String
  boardId   String
  todoId    String
  userId    String
  action    String // e.g., "CREATED" | "UPDATED" | "DELETED" | "STATUS_CHANGED"
  metadata  Json? // extra information (before/after)
  createdAt DateTime @default(now())

  // Relations
  tenant Tenant @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  board  Board  @relation(fields: [boardId], references: [id], onDelete: Cascade)
  todo   Todo   @relation(fields: [todoId], references: [id], onDelete: Cascade)
  user   User   @relation(fields: [userId], references: [id])

  @@index([tenantId])
  @@index([boardId])
  @@index([todoId])
  @@map("todo_activities")
}
